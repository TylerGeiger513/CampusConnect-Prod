apiVersion: skaffold/v4beta6
kind: Config
metadata:
  name: campus-connect

build:
  # Force the image tag to "latest"
  tagPolicy:
    customTemplate:
      template: "latest"
  artifacts:
    - image: docker.io/tylergeiger/campus-connect-backend
      context: backend
      docker:
        dockerfile: Dockerfile.backend.prod
    - image: docker.io/tylergeiger/campus-connect-frontend
      context: frontend
      docker:
        dockerfile: Dockerfile.frontend.prod

  local: 
    push: true

deploy:
  helm:
    releases:
      - name: campus-connect
        chartPath: ./helm
        valuesFiles:
          - ./helm/values.prod.yaml
        setValueTemplates:
          domain: '{{cmd "hostname" "-f"}}'

profiles:
  - name: dev
    build:
      artifacts:
        - image: docker.io/tylergeiger/campus-connect-backend
          context: backend
          docker:
            dockerfile: backend/Dockerfile.backend.dev
          sync:
            manual:
              - src: "src/**/*.ts"
                dest: "."
        - image: docker.io/tylergeiger/campus-connect-frontend
          context: frontend
          docker:
            dockerfile: frontend/Dockerfile.frontend.dev
          sync:
            manual:
              - src: "src/**/*"
                dest: "src/"
    deploy:
      helm:
        releases:
          - name: campus-connect
            chartPath: ./helm
            valuesFiles:
              - ./helm/values.dev.yaml
            setValueTemplates:
              domain: "localhost"

  - name: prod
    build:
      artifacts:
        - image: docker.io/tylergeiger/campus-connect-backend
          docker:
            dockerfile: Dockerfile.backend.prod
          sync: {} 
        - image: docker.io/tylergeiger/campus-connect-frontend
          docker:
            dockerfile: Dockerfile.frontend.prod
          sync: {}  
    deploy:
      helm:
        releases:
          - name: campus-connect
            chartPath: ./helm
            valuesFiles:
              - ./helm/values.prod.yaml
            setValueTemplates:
              domain: '{{cmd "hostname" "-f"}}'